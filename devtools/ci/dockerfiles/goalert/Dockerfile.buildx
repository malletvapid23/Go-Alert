FROM --platform=$BUILDPLATFORM goalert/build-env:go1.16.4-postgres13 AS binaries
ARG BUILDPLATFORM

COPY bin/linux-arm/goalert* /linux/arm/v7/
COPY bin/linux-arm64/goalert* /linux/arm64/
COPY bin/linux-amd64/goalert* /linux/amd64/

FROM alpine
ARG TARGETPLATFORM
RUN apk --no-cache add ca-certificates
ENV GOALERT_LISTEN :8081
EXPOSE 8081
CMD ["/usr/bin/goalert"]

COPY --from=binaries /$TARGETPLATFORM/goalert /$TARGETPLATFORM/goalert-slack-email-sync /usr/bin/
RUN /usr/bin/goalert self-test
